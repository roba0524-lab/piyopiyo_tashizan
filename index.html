<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>あわあわ足し算 ひよこ</title>

<style>
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  overflow: hidden;
  font-family: system-ui, -apple-system, sans-serif;
}

#screen {
  position: relative;
  width: 100%;
  height: 100%;
  background: #bfefff;
}

/* ===== UI ===== */
#ui {
  position: absolute;
  top: 12px;
  width: 100%;
  text-align: center;
  z-index: 10;
}

#target-number {
  width: 120px;
  height: 120px;
  border-radius: 50%;
  background: #1e3a8a;
  color: #fff;
  font-size: 64px;
  font-weight: 900;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}

#sum {
  margin-top: 6px;
  font-size: 20px;
  color: #1e3a8a;
}

#message {
  position: absolute;
  top: 32%;
  width: 100%;
  text-align: center;
  font-size: 42px;
  font-weight: 900;
  opacity: 0;
  z-index: 30;
  transition: opacity 0.3s;
}

/* ===== ひよこ ===== */
.bubble, .clear-chick {
  position: absolute;
  width: 70px;
  height: 70px;
  border-radius: 50%;
  background: #fff86b;
}

.chick-inner {
  width: 100%;
  height: 100%;
  transform-origin: center;
  animation: slow-rotate linear infinite;
}

@keyframes slow-rotate {
  from { transform: rotate(0deg); }
  to   { transform: rotate(360deg); }
}

.face {
  position: absolute;
  top: 12px;
  width: 100%;
  height: 30px;
}

.eye {
  position: absolute;
  width: 5px;
  height: 8px;
  background: #000;
  border-radius: 50%;
}
.eye.left { left: 22px; }
.eye.right { right: 22px; }

.beak {
  position: absolute;
  top: 15px;
  left: 50%;
  transform: translateX(-50%);
  border-left: 6px solid transparent;
  border-right: 6px solid transparent;
  border-top: 10px solid #f59e0b;
}

.number {
  position: absolute;
  bottom: 6px;
  width: 100%;
  text-align: center;
  font-size: 24px;
  font-weight: bold;
}

/* ===== ぼよん ===== */
@keyframes bounce {
  0%   { transform: scale(1); }
  20%  { transform: scale(1.35); }
  40%  { transform: scale(1.15); }
  60%  { transform: scale(1.25); }
  80%  { transform: scale(1.08); }
  100% { transform: scale(1); }
}

/* ===== クリア画面 ===== */
#clear-layer {
  position: absolute;
  inset: 0;
  background: white;
  z-index: 20;
  display: none;
  overflow: hidden;
}

/* ===== 紙吹雪 ===== */
.confetti {
  position: absolute;
  width: 8px;
  height: 14px;
  top: -20px;
  animation: fall linear forwards;
}

@keyframes fall {
  to {
    transform: translate(var(--dx), 110vh) rotate(360deg);
    opacity: 0.9;
  }
}
</style>
</head>

<body>
<div id="screen">
  <div id="ui">
    <div id="target-number"></div>
    <div id="sum">いま：0</div>
  </div>
  <div id="message"></div>
  <div id="clear-layer"></div>
</div>

<script>
const screen = document.getElementById("screen");
const targetNumberEl = document.getElementById("target-number");
const sumEl = document.getElementById("sum");
const messageEl = document.getElementById("message");
const clearLayer = document.getElementById("clear-layer");

const SIZE = 70;
const R = SIZE / 2;

let AREA_TOP = 160;
let bubbles = [];
let sum = 0;
let target = 0;
let running = true;
let clearCount = 0;

const rand = (a,b)=>Math.random()*(b-a)+a;

function bounce(el){
  el.style.animation="bounce 1.1s ease-out";
  el.onanimationend=()=>el.style.animation="";
}

/* ===== 初期化 ===== */
function reset(){
  clearLayer.style.display="none";
  clearLayer.innerHTML="";
  messageEl.style.opacity=0;

  sum=0;
  running=true;
  sumEl.style.display="block";
  sumEl.textContent="いま：0";

  target=Math.floor(rand(10,21));
  targetNumberEl.textContent=target;

  const rect=sumEl.getBoundingClientRect();
  AREA_TOP=rect.bottom+8;

  bubbles.forEach(b=>b.el.remove());
  bubbles=[];
  create();
}

/* ===== 重ならない初期位置 ===== */
function findSafePos(){
  for(let t=0;t<200;t++){
    const x=rand(0,innerWidth-SIZE);
    const y=rand(AREA_TOP,innerHeight-SIZE);
    if(bubbles.every(b=>Math.hypot(b.x-x,b.y-y)>=SIZE)){
      return {x,y};
    }
  }
  return {x:0,y:AREA_TOP};
}

/* ===== ひよこ生成 ===== */
function create(){
  for(let n=1;n<=9;n++){
    const el=document.createElement("div");
    el.className="bubble";
    el.innerHTML=`
      <div class="chick-inner">
        <div class="face">
          <div class="eye left"></div>
          <div class="eye right"></div>
          <div class="beak"></div>
        </div>
        <div class="number">${n}</div>
      </div>`;
    screen.appendChild(el);

    const inner=el.querySelector(".chick-inner");
    inner.style.animationDuration=rand(20,40)+"s";

    const pos=findSafePos();
    const b={ el,n, x:pos.x, y:pos.y, vx:rand(-1.4,1.4), vy:rand(-1.4,1.4), alive:true };

    el.onclick=()=>{
      if(!running||!b.alive)return;
      b.alive=false;
      sum+=n;
      sumEl.textContent=`いま：${sum}`;
      el.remove();
      if(sum===target) success();
      else if(sum>target) fail();
    };

    bubbles.push(b);
  }
}

/* ===== 成功 ===== */
function success(){
  running=false;
  clearCount++;

  bubbles.forEach(b=>b.el.remove());
  bubbles=[];
  sumEl.style.display="none";

  clearLayer.style.display="block";
  messageEl.textContent="だいせいこう！！";
  messageEl.style.opacity=1;

  playClearChicks(clearCount);
  launchConfetti();

  setTimeout(reset,4000);
}

/* ===== 失敗 ===== */
function fail(){
  running=false;
  clearCount=0;

  bubbles.forEach(b=>b.el.remove());
  bubbles=[];
  sumEl.style.display="none";

  messageEl.textContent="(´・ω・`)";
  messageEl.style.opacity=1;
  setTimeout(reset,3000);
}

/* ===== クリア演出 ===== */
function playClearChicks(count){
  const n = Math.min(count,4);
  const centerY = innerHeight * 0.55;
  const spacing = 90;
  const startX = innerWidth/2 - (n-1)*spacing/2;
  const chicks = [];

  for(let i=0;i<n;i++){
    const c=document.createElement("div");
    c.className="clear-chick";
    c.style.left=startX+i*spacing+"px";
    c.style.top=centerY+"px";
    c.style.transform="translateX(120vw)";
    c.innerHTML=`
      <div class="face">
        <div class="eye left"></div>
        <div class="eye right"></div>
        <div class="beak"></div>
      </div>`;
    clearLayer.appendChild(c);
    chicks.push(c);

    c.animate(
      [{transform:"translateX(120vw)"},{transform:"translateX(0)"}],
      {duration:500,easing:"ease-out",fill:"forwards",delay:i*80}
    );
  }

  /* ジャンプ */
  setTimeout(()=>{
    chicks.forEach((c,i)=>{
      c.animate(
        [
          {transform:"translateY(0)"},
          {transform:"translateY(-60px)"},
          {transform:"translateY(0)"}
        ],
        {duration:400,easing:"ease-out",delay:i*80}
      );
    });
  },700);

  /* 4回目：ぼよよよーーん → 四散 */
  if(count>=4){
    setTimeout(()=>{
      chicks.forEach(c=>{
        c.animate(
          [
            {transform:"scale(1)"},
            {transform:"scale(1.4)"},
            {transform:"scale(0.9)"},
            {transform:"scale(1.2)"},
            {transform:"scale(1)"}
          ],
          {duration:900,easing:"ease-out"}
        );
      });
    },1200);

    setTimeout(()=>{
      chicks.forEach(c=>{
        c.animate(
          [
            {transform:"translate(0,0) scale(1)"},
            {transform:`translate(${rand(-300,300)}px,${rand(-300,300)}px) scale(0)`}
          ],
          {duration:700,easing:"ease-in",fill:"forwards"}
        );
      });
    },2200);

    return;
  }

  /* 1〜3回目：左へ退場 */
  setTimeout(()=>{
    chicks.forEach((c,i)=>{
      c.animate(
        [{transform:"translateX(0)"},{transform:"translateX(-120vw)"}],
        {duration:500,easing:"ease-in",fill:"forwards",delay:i*80}
      );
    });
  },1600);
}

/* ===== 紙吹雪 ===== */
function launchConfetti(){
  for(let i=0;i<25;i++){
    const c=document.createElement("div");
    c.className="confetti";
    c.style.left=rand(0,innerWidth)+"px";
    c.style.background=`hsl(${rand(0,360)},80%,60%)`;
    c.style.animationDuration=rand(2,3)+"s";
    c.style.setProperty("--dx",rand(-150,150)+"px");
    clearLayer.appendChild(c);
  }
}

/* ===== メインループ ===== */
function loop(){
  bubbles.forEach((b,i)=>{
    if(!b.alive)return;

    b.x+=b.vx;
    b.y+=b.vy;

    if(b.x<=0||b.x>=innerWidth-SIZE){b.vx*=-1;bounce(b.el);}
    if(b.y<=AREA_TOP||b.y>=innerHeight-SIZE){b.vy*=-1;bounce(b.el);}

    for(let j=i+1;j<bubbles.length;j++){
      const o=bubbles[j];
      if(!o.alive)continue;
      const dx=(b.x+R)-(o.x+R);
      const dy=(b.y+R)-(o.y+R);
      const d=Math.hypot(dx,dy);
      if(d<SIZE){
        const nx=dx/d,ny=dy/d;
        b.x+=nx*1.5; b.y+=ny*1.5;
        o.x-=nx*1.5; o.y-=ny*1.5;
      }
    }

    b.x=Math.max(0,Math.min(innerWidth-SIZE,b.x));
    b.y=Math.max(AREA_TOP,Math.min(innerHeight-SIZE,b.y));

    b.el.style.left=b.x+"px";
    b.el.style.top=b.y+"px";
  });

  requestAnimationFrame(loop);
}

reset();
loop();
</script>
</body>
</html>
